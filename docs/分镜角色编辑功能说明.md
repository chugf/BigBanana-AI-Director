# 分镜角色编辑功能说明

**版本**：v1.2.0  
**日期**：2025-12-18  
**功能**：编辑每个分镜（SHOT）中的角色列表

---

## 🎯 功能概述

在每个分镜中，您现在可以：
- ✅ **添加角色** - 将角色添加到分镜中
- ✅ **移除角色** - 从分镜中移除角色
- ✅ **实时更新** - 修改立即保存到项目

### 为什么需要这个功能？

**关键原因**：分镜中的角色列表会直接影响**导演工作台**生成关键帧时传入的**角色参考图**。

- 如果分镜中包含某个角色，系统会传入该角色的参考图，确保生成的图像中角色外观一致
- 如果AI自动识别的角色不准确，可以手动调整，避免生成错误的图像

---

## 📍 功能位置

**剧本清单页面** → **分镜列表** → **角色标签区域**

---

## 🎨 界面说明

### 默认状态（未编辑）
```
┌────────────────────────────────────────┐
│ SHOT 003                               │
├────────────────────────────────────────┤
│ MED                                    │
│ DOLLY                                  │
│                                        │
│ Alex walking into spaceship...         │
│                                        │
│ 角色 ✏️                                │
│ [Alex] [Sarah]                         │ ← 当前角色标签
└────────────────────────────────────────┘
```

### 编辑状态
```
┌────────────────────────────────────────┐
│ SHOT 003                               │
├────────────────────────────────────────┤
│ MED                                    │
│ DOLLY                                  │
│                                        │
│ Alex walking into spaceship...         │
│                                        │
│ 角色                                   │
│ ┌────────────────────────────────────┐ │
│ │ 当前角色                           │ │
│ │ [Alex ✗] [Sarah ✗]                │ │ ← 可移除
│ │                                    │ │
│ │ 添加角色                           │ │
│ │ [➕ John] [➕ Emma]                │ │ ← 可添加
│ │                                    │ │
│ │ [✓ 完成]                           │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
```

---

## 🚀 使用步骤

### 1. 进入编辑模式

1. 在剧本清单页面，找到需要编辑的分镜
2. 在"角色"标签区域，鼠标悬停
3. 点击右侧的 **✏️ 编辑图标**
4. 进入角色编辑模式

### 2. 移除角色

在"当前角色"区域：
1. 找到要移除的角色标签
2. 点击角色名称右侧的 **✗ 按钮**
3. 角色立即从分镜中移除

**示例**：
- 原始：`[Alex] [Sarah] [John]`
- 点击 Sarah 的 ✗
- 结果：`[Alex] [John]`

### 3. 添加角色

在"添加角色"区域：
1. 查看可添加的角色列表（显示所有未在当前分镜中的角色）
2. 点击 **➕ 角色名称** 按钮
3. 角色立即添加到分镜中

**示例**：
- 原始：`[Alex]`
- 可添加：`[➕ Sarah] [➕ John]`
- 点击 ➕ Sarah
- 结果：`[Alex] [Sarah]`

### 4. 完成编辑

点击 **✓ 完成** 按钮，退出编辑模式。

---

## 💡 使用场景

### 场景 1：AI 识别错误

**问题**：AI 自动识别分镜中有 3 个角色，但实际只有 2 个

**解决方案**：
1. 点击编辑角色
2. 移除多余的角色
3. 完成编辑

**效果**：导演工作台生成关键帧时，只会传入正确的 2 个角色参考图

---

### 场景 2：需要添加背景角色

**问题**：分镜描述中提到"人群中的 Alex"，但 AI 只识别了 Alex

**解决方案**：
1. 点击编辑角色
2. 添加其他需要出现的角色（如群众演员）
3. 完成编辑

**效果**：生成的关键帧会包含所有角色的参考图，画面更丰富

---

### 场景 3：角色替换

**问题**：原本是 Alex 的镜头，想改成 Sarah

**解决方案**：
1. 点击编辑角色
2. 移除 Alex
3. 添加 Sarah
4. 完成编辑

**效果**：生成的关键帧会使用 Sarah 的参考图而不是 Alex

---

### 场景 4：无角色镜头

**问题**：某个镜头是纯景物镜头（如：远景城市天际线），不需要角色

**解决方案**：
1. 点击编辑角色
2. 移除所有角色
3. 完成编辑

**效果**：生成关键帧时不会传入任何角色参考图，专注于场景

---

## 🔗 与其他功能的关联

### 1. 素材准备阶段

在"素材准备"阶段，您会为每个角色生成**参考图**（定妆照）。

- 这些参考图会在"导演工作台"生成关键帧时使用
- 分镜中包含哪些角色，就会传入哪些角色的参考图

### 2. 导演工作台阶段

在"导演工作台"生成关键帧时：

```typescript
// 伪代码示例
function generateKeyframe(shot) {
  const referenceImages = [];
  
  // 添加场景参考图
  referenceImages.push(shot.scene.referenceImage);
  
  // 添加角色参考图（根据 shot.characters）
  shot.characters.forEach(characterId => {
    const character = findCharacter(characterId);
    referenceImages.push(character.referenceImage);
  });
  
  // 使用参考图生成关键帧
  return generateImage(shot.visualPrompt, referenceImages);
}
```

**关键点**：
- `shot.characters` 决定了传入哪些角色参考图
- 修改角色列表会直接影响生成的图像质量和准确性

---

## ⚠️ 注意事项

### 1. 角色必须先在剧本中定义

- 只能添加在"演员表"中已存在的角色
- 如果需要新角色，需要先在剧本中定义（或手动添加到项目数据）

### 2. 移除角色不会删除角色数据

- 移除角色只是将其从当前分镜中移除
- 角色本身仍然存在于项目的"演员表"中
- 可以随时重新添加回分镜

### 3. 修改立即生效

- 所有修改立即保存到项目
- 无需手动"保存项目"
- 如果误操作，可以立即重新编辑恢复

### 4. 影响已生成的图像

- 如果已经在"导演工作台"生成了关键帧，修改角色列表后需要**重新生成**
- 系统不会自动更新已生成的图像

---

## 🎯 最佳实践

### 1. 精准控制角色出现

**建议**：仔细检查每个分镜的角色列表，确保只包含实际出现的角色

**原因**：
- 传入过多角色参考图会增加生成复杂度
- 可能导致生成的图像中出现不应该出现的角色

### 2. 主角优先

**建议**：如果分镜中有多个角色，将主角放在前面

**操作**：
- 先移除所有角色
- 按重要性顺序重新添加（主角 → 配角 → 群众）

**原因**：
- 某些图像生成模型对参考图顺序敏感
- 优先处理的参考图可能获得更高权重

### 3. 群众角色处理

**建议**：如果分镜中有大量群众，不要添加所有群众角色

**操作**：
- 只添加有台词或特写的群众角色
- 其他群众让 AI 自由发挥

**原因**：
- 过多参考图会降低生成速度
- 背景群众不需要严格的一致性

### 4. 定期检查

**建议**：在进入"导演工作台"之前，系统性检查所有分镜的角色列表

**检查清单**：
- [ ] 每个分镜的角色列表是否准确？
- [ ] 是否有多余的角色？
- [ ] 是否有遗漏的角色？
- [ ] 角色顺序是否合理（主角在前）？

---

## 🔧 技术细节

### 数据结构

```typescript
interface Shot {
  id: string;
  sceneId: string;
  characters: string[];  // 角色 ID 数组（可编辑）
  // ... 其他字段
}
```

### 操作逻辑

#### 添加角色
```typescript
// 检查角色是否已存在
if (!shot.characters.includes(characterId)) {
  shot.characters.push(characterId);
}
```

#### 移除角色
```typescript
shot.characters = shot.characters.filter(cid => cid !== characterId);
```

### 存储

- 修改后的角色列表立即保存到 `project.shots`
- 自动同步到 `localStorage`
- 无需额外的保存操作

---

## 🐛 常见问题

### Q1: 为什么某些角色无法添加？

**A**: 只能添加在"演员表"中已定义的角色。如果需要新角色：
1. 返回"剧本与故事"阶段
2. 修改剧本，添加新角色
3. 重新生成分镜

### Q2: 移除角色后能恢复吗？

**A**: 可以。移除只是从当前分镜中移除，角色数据仍然存在。只需重新点击"添加角色"即可恢复。

### Q3: 修改角色列表后，已生成的图像会自动更新吗？

**A**: 不会。需要在"导演工作台"手动点击"重新生成"按钮。

### Q4: 可以批量修改多个分镜的角色吗？

**A**: 目前不支持批量操作，需要逐个分镜编辑。未来版本可能会添加此功能。

### Q5: 如果分镜中没有角色，会影响生成吗？

**A**: 不会。无角色分镜会正常生成，只是不会传入角色参考图，适合纯景物镜头。

---

## 📊 功能对比

| 功能 | 之前 | 现在 |
|------|------|------|
| 角色识别 | AI 自动识别 | AI 识别 + 手动调整 ✅ |
| 角色准确性 | 可能不准确 | 完全可控 ✅ |
| 添加角色 | ❌ 不支持 | ✅ 支持 |
| 移除角色 | ❌ 不支持 | ✅ 支持 |
| 实时更新 | - | ✅ 立即保存 |

---

## 🔮 未来改进

### 计划中的功能
- [ ] 批量编辑多个分镜的角色
- [ ] 角色出场统计（显示每个角色在多少个分镜中出现）
- [ ] 智能建议（AI 建议应该添加或移除的角色）
- [ ] 角色时间轴（可视化角色在各分镜中的出现）
- [ ] 拖拽排序（调整角色在列表中的顺序）

---

## 📞 反馈与支持

如果您在使用过程中遇到问题或有改进建议，欢迎反馈！

---

**功能已完成并准备就绪！** 🎬✨

