# 参考图上传功能说明

## 功能概述

新增了手动上传图片作为角色和场景参考图的功能。用户现在可以选择：
1. **AI生成参考图**（原有功能）
2. **手动上传参考图**（新增功能）

## 功能位置

### 1. 角色参考图上传

**位置**：Phase 02 - 角色与场景 > 角色定妆部分

- **未生成图片时**：每个角色卡片显示"生成"和"上传"两个按钮
- **已有图片时**：在"服装变体"按钮下方，显示"重新生成"和"上传图片"两个按钮

### 2. 场景参考图上传

**位置**：Phase 02 - 角色与场景 > 场景概念部分

- **未生成图片时**：每个场景卡片显示"生成"和"上传"两个按钮
- **已有图片时**：在场景详情底部，显示"重新生成"和"上传图片"两个按钮

### 3. 角色变体参考图上传

**位置**：点击角色的"服装变体"按钮 > Wardrobe 模态框

- 每个变体条目中，在"Generate/Regenerate"按钮旁边添加了"Upload"按钮

## 技术实现

### 新增工具函数

**文件**：`services/storageService.ts`

```typescript
export const convertImageToBase64 = (file: File): Promise<string>
```

**功能**：
- 将用户上传的图片文件转换为 Base64 格式
- 验证文件类型（仅支持图片格式）
- 验证文件大小（最大 10MB）
- 返回 data URL 格式（`data:image/png;base64,...`）

### 上传处理函数

**文件**：`components/StageAssets.tsx`

1. **`handleUploadCharacterImage(charId, file)`** - 处理角色参考图上传
2. **`handleUploadSceneImage(sceneId, file)`** - 处理场景参考图上传
3. **`handleUploadVariationImage(charId, varId, file)`** - 处理角色变体参考图上传

所有函数都会：
- 调用 `convertImageToBase64()` 转换图片
- 更新对应的 `referenceImage` 字段
- 保存到项目数据中
- 显示错误提示（如果上传失败）

## 使用限制

- **支持格式**：所有常见图片格式（PNG, JPG, GIF, WEBP 等）
- **文件大小**：最大 10MB
- **存储方式**：Base64 格式存储在 IndexedDB 中

## UI 设计

### 上传按钮样式
- 使用 `Upload` 图标（lucide-react）
- 与"生成"按钮并排显示
- 使用 HTML5 `<input type="file">` 隐藏输入框
- 点击按钮触发文件选择对话框

### 颜色方案
- **角色/场景上传按钮**：zinc 灰色系，与重新生成按钮保持一致
- **变体上传按钮**：emerald 绿色系，与生成按钮形成视觉区分

## 使用场景

1. **自定义参考图**：用户有特定的角色或场景图片想要使用
2. **快速原型**：跳过 AI 生成，直接使用现有素材
3. **精确控制**：使用外部工具生成/编辑好的图片
4. **节省 API 调用**：减少 AI 生成的次数和成本

## 兼容性

- ✅ 与现有 AI 生成功能完全兼容
- ✅ 上传的图片与 AI 生成的图片使用相同的存储格式
- ✅ 支持替换已有的参考图（AI 生成或上传的）
- ✅ 在分镜导演阶段可正常作为参考图使用

## 注意事项

1. **图片大小**：建议上传适当大小的图片（推荐 1920x1080 以内），避免存储空间过大
2. **格式选择**：推荐使用 JPG 格式以平衡质量和文件大小
3. **清除重置**：上传后可随时通过"重新生成"按钮用 AI 替换，或再次上传新图片
