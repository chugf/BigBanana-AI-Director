# 镜头拆分功能 - 关键帧visualPrompt修复说明

## 🐛 问题描述

**原问题**：拆分出来的子镜头没有画面提示词（visualPrompt）

拆分后的子镜头的 `keyframes` 数组为空，用户需要手动为每个子镜头的起始帧和结束帧生成提示词，操作繁琐。

## ✅ 解决方案

让AI在拆分镜头时，**同时生成每个子镜头的关键帧及其visualPrompt**，这样拆分后的子镜头立即拥有完整的画面提示词，用户可以直接点击"生成"按钮生成图像。

## 🔧 修复内容

### 1. 更新AI Prompt (`services/geminiService.ts`)

**增加关键帧要求**：

```
5. **keyframes**（关键帧数组）：包含起始帧(start)和结束帧(end)的视觉描述
   - 每个关键帧必须包含：
     - **type**: "start" 或 "end"
     - **visualPrompt**: 详细的画面视觉描述（用于AI图像生成），
       包含场景、人物、光影、构图等细节（100-150字）
```

**更新输出格式示例**：

```json
{
  "subShots": [
    {
      "shotSize": "全景 Wide Shot",
      "cameraMovement": "静止镜头 Static Shot",
      "actionSummary": "...",
      "visualFocus": "...",
      "keyframes": [
        {
          "type": "start",
          "visualPrompt": "书房全景，真人实拍电影风格，我站在门口，身体朝向书桌方向，准备迈步。房间中央是深色木质书桌，背后是装满书籍的书架，窗户透进柔和的自然光，营造温馨的学习氛围。构图采用三分法，人物位于左侧，书桌位于画面中心。"
        },
        {
          "type": "end",
          "visualPrompt": "书房全景，真人实拍电影风格，我已走到书桌旁边，身体靠近椅子，手即将触碰椅背。画面保持整体环境视角，展示完整的移动轨迹。光线保持一致，强调空间的纵深感。"
        }
      ]
    }
  ]
}
```

**关键帧visualPrompt要求**：
- 必须包含视觉风格标记（如"真人实拍电影风格"）
- 详细描述画面构图、光影、色彩、景深等视觉元素
- 起始帧和结束帧要有明显的视觉差异，体现动作过程
- 长度控制在100-150字，既详细又不过于冗长
- 使用专业的摄影和美术术语

### 2. 增强数据验证 (`services/geminiService.ts`)

```typescript
// 验证关键帧数组
if (!subShot.keyframes || !Array.isArray(subShot.keyframes) || subShot.keyframes.length === 0) {
  throw new Error('子镜头缺少关键帧数组（keyframes）');
}

// 验证每个关键帧
for (const kf of subShot.keyframes) {
  if (!kf.type || !kf.visualPrompt) {
    throw new Error('关键帧缺少必需字段（type、visualPrompt）');
  }
  if (kf.type !== 'start' && kf.type !== 'end') {
    throw new Error('关键帧type必须是"start"或"end"');
  }
}
```

### 3. 更新子镜头创建逻辑 (`components/StageDirector/utils.ts`)

**修改前**：
```typescript
keyframes: [], // 初始化空的关键帧数组
```

**修改后**：
```typescript
// 处理关键帧数组
const keyframes: any[] = [];
if (subShotData.keyframes && Array.isArray(subShotData.keyframes)) {
  subShotData.keyframes.forEach((kf: any) => {
    if (kf.type && kf.visualPrompt) {
      keyframes.push({
        id: `${subShotId}-${kf.type}`, // 如 "shot-1-1-start", "shot-1-1-end"
        type: kf.type,
        visualPrompt: kf.visualPrompt,
        status: 'pending' // 初始状态为pending，等待用户生成图像
      });
    }
  });
}

return {
  // ...
  keyframes: keyframes, // 使用AI生成的关键帧（包含visualPrompt）
  // ...
};
```

## 🎯 修复效果

### 修复前 ❌

拆分后的子镜头结构：
```json
{
  "id": "shot-1-1",
  "actionSummary": "镜头从书房门口...",
  "cameraMovement": "静止镜头",
  "shotSize": "全景 Wide Shot",
  "keyframes": []  // ❌ 空数组，没有提示词
}
```

用户需要：
1. 点击子镜头
2. 手动点击"生成起始帧"
3. 手动点击"生成结束帧"
4. 等待AI生成提示词
5. 再点击生成图像

### 修复后 ✅

拆分后的子镜头结构：
```json
{
  "id": "shot-1-1",
  "actionSummary": "镜头从书房门口...",
  "cameraMovement": "静止镜头",
  "shotSize": "全景 Wide Shot",
  "keyframes": [
    {
      "id": "shot-1-1-start",
      "type": "start",
      "visualPrompt": "书房全景，真人实拍电影风格，我站在门口...",  // ✅ 已有完整提示词
      "status": "pending"
    },
    {
      "id": "shot-1-1-end",
      "type": "end",
      "visualPrompt": "书房全景，真人实拍电影风格，我已走到书桌旁...",  // ✅ 已有完整提示词
      "status": "pending"
    }
  ]
}
```

用户只需要：
1. 点击子镜头
2. 直接点击"生成起始帧"图像按钮
3. 直接点击"生成结束帧"图像按钮
4. **无需等待AI生成提示词**，因为已经有了！

## 📊 优势对比

| 功能 | 修复前 | 修复后 |
|------|--------|--------|
| 拆分后keyframes | 空数组 | 包含完整的起始帧和结束帧 |
| visualPrompt | ❌ 无 | ✅ 有（100-150字详细描述） |
| 用户操作步骤 | 5步 | 3步 |
| 需要等待AI | 2次（生成提示词） | 0次 |
| 用户体验 | 繁琐 | 流畅 |
| 拆分完整性 | 不完整 | 完整 |

## 🎬 实际使用示例

**原始镜头**：
```
动作：我在书房走向书桌坐下来，打开电脑
```

**拆分后的子镜头1（全景）**：
```json
{
  "shotSize": "全景 Wide Shot",
  "actionSummary": "镜头从书房门口的角度，展示整个书房空间，我从门口缓步走向位于房间中央的书桌",
  "keyframes": [
    {
      "type": "start",
      "visualPrompt": "书房全景，真人实拍电影风格，我站在门口，身体朝向书桌方向，准备迈步。房间中央是深色木质书桌，背后是装满书籍的书架，窗户透进柔和的自然光，营造温馨的学习氛围。构图采用三分法，人物位于左侧，书桌位于画面中心。摄影机固定位置，8K高清，电影级景深。"
    },
    {
      "type": "end",
      "visualPrompt": "书房全景，真人实拍电影风格，我已走到书桌旁边，身体靠近椅子，手即将触碰椅背。画面保持整体环境视角，展示完整的移动轨迹。光线保持一致，强调空间的纵深感。人物位于画面右侧，完成了从左到右的移动。"
    }
  ]
}
```

用户现在可以：
✅ 直接点击生成起始帧图像
✅ 直接点击生成结束帧图像
✅ 无需任何中间步骤

## 🧪 测试建议

1. **简单场景测试**：
   - 原始镜头："我走到门口开门"
   - 验证拆分后每个子镜头都有完整的keyframes和visualPrompt

2. **复杂场景测试**：
   - 原始镜头："两人激烈打斗，拳拳到肉"
   - 验证AI能为不同景别（全景、中景、特写）生成合适的visualPrompt

3. **对白场景测试**：
   - 原始镜头："他说：'你好'，然后握手"
   - 验证对白被正确融入actionSummary和visualPrompt

4. **生成图像测试**：
   - 拆分后直接生成关键帧图像
   - 验证visualPrompt的质量和准确性

## 📝 总结

✅ **问题已修复**：拆分出来的子镜头现在包含完整的关键帧和visualPrompt

✅ **用户体验提升**：从5步操作减少到3步，无需等待AI生成提示词

✅ **数据完整性**：拆分后的子镜头立即可用，无需额外处理

✅ **代码质量**：增加了完善的数据验证，确保AI返回格式正确

---

**修改文件清单**：
1. ✅ `services/geminiService.ts` - 更新AI Prompt和验证逻辑
2. ✅ `components/StageDirector/utils.ts` - 更新createSubShot函数处理关键帧

**无linter错误** ✅

