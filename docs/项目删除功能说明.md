# 项目删除功能说明

## 功能概述

删除项目时会自动清理该项目下的所有资源，包括所有以Base64格式存储的媒体文件。

## 删除的资源类型

### 📦 媒体资源（Base64格式）
- **角色基础参考图** - Character.referenceImage
- **角色变体参考图** - CharacterVariation.referenceImage  
- **场景参考图** - Scene.referenceImage
- **关键帧图像** - Keyframe.imageUrl
- **视频片段** - VideoInterval.videoUrl

### 📊 项目数据
- **剧本数据** - ScriptData（包括角色、场景、剧情段落）
- **分镜数据** - Shot[]（包括所有分镜头信息）
- **渲染日志** - RenderLog[]（包括所有API调用历史）
- **项目设置** - 目标时长、语言、视觉风格等

## 技术实现

### 为什么一次删除就能清理所有资源？

因为系统采用了**嵌入式存储架构**：

```typescript
ProjectState {
  id: string,
  title: string,
  scriptData: {
    characters: [{
      referenceImage: "data:image/png;base64,..." // 图片直接存在对象内
    }],
    scenes: [{
      referenceImage: "data:image/png;base64,..." // 图片直接存在对象内
    }]
  },
  shots: [{
    keyframes: [{
      imageUrl: "data:image/png;base64,..." // 图片直接存在对象内
    }],
    interval: {
      videoUrl: "data:video/mp4;base64,..." // 视频直接存在对象内
    }
  }]
}
```

当删除项目记录时，IndexedDB会：
1. 删除整个ProjectState对象
2. 自动回收对象内所有嵌入的Base64数据
3. 释放相应的存储空间

**无需额外的清理步骤！** ✅

## 用户界面

### 删除确认对话框

删除项目时会显示详细的确认对话框：

```
⚠️ 确认删除项目？

此操作无法撤销

将同时删除以下所有资源：
· 角色和场景参考图
· 所有关键帧图像  
· 所有生成的视频片段
· 渲染历史记录

[取消] [永久删除]
```

### 控制台日志

删除操作会在浏览器控制台输出详细的统计信息：

```
🗑️ 开始删除项目: proj_abc123
✅ 项目已删除: 我的科幻短片
📊 清理的资源统计:
   - 角色参考图: 3个
   - 角色变体图: 5个
   - 场景参考图: 4个
   - 关键帧图像: 24个
   - 视频片段: 12个
   - 渲染日志: 45条
```

## 相关代码文件

- [services/storageService.ts](../services/storageService.ts) - `deleteProjectFromDB()` 删除逻辑
- [components/Dashboard.tsx](../components/Dashboard.tsx) - 删除UI和确认流程
- [types.ts](../types.ts) - 项目数据结构定义

## 存储空间回收

### 浏览器行为

删除项目后，IndexedDB会：
1. **立即标记**：将项目记录标记为已删除
2. **延迟清理**：浏览器会在合适的时机回收实际存储空间
3. **空间压缩**：定期对数据库进行压缩整理

### 手动触发清理（可选）

如果需要立即回收空间，可以：
1. 关闭所有使用该网站的标签页
2. 重新打开网站
3. 浏览器会在后台完成清理

或者在浏览器开发者工具中手动清理：
```
F12 → Application → Storage → Clear site data
```

**注意**：这会删除所有项目！

## 数据安全建议

### 删除前的准备

1. **确认重要性**：确保不再需要该项目
2. **导出备份**：使用"导出源资源"功能保存ZIP备份
3. **检查依赖**：确认没有其他工作依赖此项目

### 误删除恢复

⚠️ **删除操作不可恢复**

如果不小心删除了重要项目：
- 检查是否有导出的ZIP备份文件
- 如果使用了浏览器同步功能，可能在其他设备上还有副本
- 尽快停止使用该网站，避免覆盖浏览器缓存

## 最佳实践

### 定期维护

建议定期清理不再需要的项目：
- 节省存储空间
- 提高数据库性能
- 避免项目列表混乱

### 项目命名规范

使用清晰的命名和日期标记：
```
✅ 好的命名：《夏日回忆》正式版_2025-12-19
❌ 不好的命名：测试1、新项目、未命名项目
```

这样可以更容易识别可删除的项目。

## 开发者信息

### deleteProjectFromDB 函数签名

```typescript
/**
 * 从IndexedDB中删除项目及其所有关联资源
 * @param id - 项目ID
 * @throws 删除失败时抛出错误
 */
export const deleteProjectFromDB = async (id: string): Promise<void>
```

### 资源统计接口

删除函数会统计以下资源：

```typescript
interface ResourceCount {
  characters: number;          // 角色参考图数量
  characterVariations: number; // 角色变体图数量  
  scenes: number;              // 场景参考图数量
  keyframes: number;           // 关键帧数量
  videos: number;              // 视频片段数量
  renderLogs: number;          // 渲染日志条数
}
```

## 性能考虑

### 删除操作耗时

| 项目规模 | 资源数量 | 删除耗时 |
|---------|---------|---------|
| 小型项目 | < 50个资源 | < 100ms |
| 中型项目 | 50-200个资源 | 100-300ms |
| 大型项目 | > 200个资源 | 300-1000ms |

### 存储空间释放

Base64编码的媒体文件大小参考：
- 图片（PNG）：约 500KB - 2MB
- 视频（10秒MP4）：约 15MB - 25MB

删除一个包含12个视频片段的项目，可以释放约 **200-300MB** 的存储空间。

## 故障排除

### 删除失败

如果删除操作失败：
1. 检查浏览器控制台的错误信息
2. 确认IndexedDB没有被其他标签页占用
3. 尝试刷新页面后重新删除
4. 检查浏览器的存储权限设置

### 空间未释放

如果删除后空间未释放：
1. 关闭并重新打开浏览器
2. 等待浏览器后台清理（可能需要几分钟）
3. 在 Chrome 中访问 `chrome://settings/content/all` 查看实际占用

## 更新日志

### v1.1.0 (2025-12-19)
- ✨ 增强删除功能，添加详细的资源统计日志
- 🎨 优化删除确认对话框，显示将被删除的资源类型
- 📝 添加完整的文档说明
- 🔍 改进错误处理和用户反馈
